# 微信自动发送群消息工具

这是一个基于 Python + PyAutoGUI + OpenCV 的 RPA（机器人流程自动化）工具，用于在本地电脑上自动操作微信 PC 版，向指定群聊发送消息。

> ⚠️ 注意：该工具仅适用于已登录的微信 PC 版，模拟用户操作，不依赖微信 API。

---

## 📦 功能简介

- **自动微信管理**：检测微信是否已启动，未启动则自动启动并登录
- **智能窗口操作**：自动切换到微信窗口，支持处理最小化窗口
- **群聊定位**：使用图像识别和文本输入相结合的方式精确查找群聊
- **消息管理**：支持直接输入消息或自动发送消息
- **配置灵活**：通过配置文件修改群名、消息内容和行为模式
- **外部文件支持**：支持从外部文件读取消息内容，便于管理长文本
- **变量替换**：支持动态变量（如日期、时间）在消息中的自动替换
- **界面校准**：提供搜索框坐标校准功能，适应不同屏幕分辨率
- **详细日志**：提供全面的日志记录，方便排查问题

## 📁 项目结构
```
wechat_rpa/
│
├── config.yaml               # 配置文件（群名、消息、路径等设置）
├── message.txt               # 消息文件（可选，支持变量替换）
├── png/                      # UI识别所需的模板图片目录
│   ├── group_result_template.png  # 群聊搜索结果模板图
│   ├── group_result_backup.png    # 群聊搜索结果备用模板图
│   ├── search_icon_template.png   # 搜索框图标模板图
│   └── search_icon_backup.png     # 搜索框图标备用模板图
├── main.py                   # 主程序脚本
├── wechat_rpa.log            # 运行日志文件（自动生成）
├── requirements.txt          # 依赖库列表
└── README.md                 # 使用说明文档
```

## 🧰 使用步骤

### 1. 克隆或创建项目目录

### 2. 准备虚拟环境

```bash
python -m venv venv
venv\Scripts\activate   # Windows
source venv/bin/activate # Linux/macOS
```

### 3. 安装依赖
```bash
pip install -r requirements.txt
```

### 4. 准备模板图片
项目使用图像识别技术定位微信界面元素，需要准备以下模板图片：

1. **群聊搜索结果**：在微信中搜索目标群聊，截取左侧搜索结果的图片
   - 保存为：`png/group_result_template.png`
   - 如有必要，可准备备用模板：`png/group_result_backup.png`

2. **搜索图标**：截取微信主界面中的搜索图标
   - 保存为：`png/search_icon_template.png`
   - 如有必要，可准备备用模板：`png/search_icon_backup.png`

> 💡 提示：截图时尽量只包含目标元素及其少量周围内容，保持图片清晰，避免过多无关元素。

### 5. 修改配置文件 config.yaml
```yaml
# 微信安装路径（注意使用双反斜杠或原始字符串格式）
wechat_path: "D:\\app\\WeChat\\WeChat.exe"  

# 目标群聊名称（需要完全匹配）
group_name: "AI研发工作室飙能群"            

# 要发送的消息内容（当message_file不可用时使用）
message: "你好，这是一条自动发送的消息。"    

# 可选：从外部文件读取消息（优先级高于message）
message_file: "message.txt"                

# 是否自动发送消息（true-发送，false-仅输入不发送）
auto_send: false                           

# 搜索框坐标（由校准功能自动生成，通常不需手动修改）
# search_box_x: 745
# search_box_y: 273
```

### 6. 准备消息文件（可选）
如果需要发送较长的消息或使用变量替换功能，可以创建`message.txt`文件：

```text
大家好！

这是一条从外部文件读取的测试消息。
当前时间: {time}
今天日期: {date}
周几: {weekday}

--自动发送
```

支持的变量：
- `{time}` - 当前时间（如：14:30:45）
- `{date}` - 当前日期（如：2025-05-16）
- `{datetime}` - 完整日期时间（如：2025-05-16 14:30:45）
- `{weekday}` - 星期几（如：Monday）

### 7. 校准搜索框坐标（推荐）
首次使用时强烈建议校准搜索框坐标，以提高识别成功率：
```bash
python main.py --calibrate
```
按照提示，在5秒倒计时内将鼠标移动到微信搜索框的中心位置。

### 8. 启动程序
标准模式：
```bash
python main.py
```

调试模式（显示更详细的日志）：
```bash
python main.py --debug
```

## ⚠️ 常见问题与解决方案

1. **无法识别搜索框**
   - 运行校准程序：`python main.py --calibrate`
   - 更新搜索框模板图片：确保`png/search_icon_template.png`清晰可辨

2. **无法找到群聊**
   - 确保群名称在配置文件中拼写完全正确（包括空格等）
   - 更新群聊模板图片，确保图片清晰完整
   - 检查日志文件`wechat_rpa.log`确认实际搜索的群名

3. **权限问题**
   - 以管理员身份运行命令提示符或PowerShell
   - 确保程序有权限操作微信窗口和使用剪贴板

4. **窗口激活失败**
   - 手动将微信窗口置于前台，然后再运行程序
   - 检查微信是否处于锁定状态或需要重新登录

5. **消息输入问题**
   - 确保消息内容不包含特殊控制字符
   - 如果消息很长，优先使用message.txt文件

6. **提高运行成功率的技巧**
   - 保持桌面整洁，避免其他窗口干扰识别
   - 使用固定的微信窗口大小和位置
   - 定期更新模板图片以适应微信界面变化

## 🛠️ 高级用法

### 命令行参数
```bash
# 校准搜索框坐标
python main.py --calibrate

# 启用详细调试日志
python main.py --debug

# 同时使用多个参数
python main.py --calibrate --debug
```

### 日志分析
程序运行时会生成详细的日志文件`wechat_rpa.log`，包含每一步操作的详情，是排查问题的重要工具。

---

## 📝 技术实现说明

本工具结合多种技术实现全自动化操作：

1. **PyAutoGUI**：模拟键盘鼠标输入
2. **OpenCV**：图像识别，用于定位界面元素
3. **剪贴板技术**：确保中文和特殊字符的可靠输入
4. **PyGetWindow**：窗口管理和激活

这种混合方法既利用了图像识别的灵活性，又克服了纯图像识别在文本输入方面的局限性，使得工具可以更可靠地在各种环境中运行。
